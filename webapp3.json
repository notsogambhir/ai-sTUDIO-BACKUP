{
  "pages/AdminPanel.tsx": "/**\n * @file AdminPanel.tsx\n * @description\n * This component acts as the main \"container\" or \"router\" for all the pages\n * that are exclusive to the Administrator role.\n *\n * It's a very simple component with one main job:\n * 1.  It receives a `view` prop (property) from the main app router (`App.tsx`).\n *     This prop tells it which admin page to display (e.g., \"Academic Structure\").\n * 2.  Based on the `view`, it uses a `switch` statement (which is like a series of \"if\"\n *     statements) to render the correct component for that view.\n *\n * This keeps the main `App.tsx` router cleaner and centralizes the logic for\n * displaying different admin-only pages.\n */\n\nimport React from 'react';\n// We import all the different \"tabs\" or \"pages\" that can be shown within the admin panel.\nimport AdminAcademicStructureTab from '../components/admin/AdminAcademicStructureTab';\nimport AdminUserManagementTab from '../components/admin/AdminUserManagementTab';\nimport AdminSystemSettingsTab from '../components/admin/AdminSystemSettingsTab';\n\n// This defines the allowed values for the `view` prop. It can only be one of these three strings.\ntype AdminView = 'Academic Structure' | 'User Management' | 'System Settings';\n\n// This defines the full set of props that the component accepts.\ninterface AdminPanelProps {\n  view: AdminView;\n}\n\n// A simple helper object to map the `view` prop to a nice-looking title for the page.\nconst viewTitles: Record<AdminView, string> = {\n  'Academic Structure': 'Academic Structure',\n  'User Management': 'User Management',\n  'System Settings': 'System Settings',\n};\n\n// This is the main component function for the Admin Panel.\nconst AdminPanel: React.FC<AdminPanelProps> = ({ view }) => {\n  /**\n   * This function decides which component to show based on the `view` prop.\n   */\n  const renderContent = () => {\n    switch (view) {\n      case 'Academic Structure':\n        return <AdminAcademicStructureTab />;\n      case 'User Management':\n        return <AdminUserManagementTab />;\n      case 'System Settings':\n        return <AdminSystemSettingsTab />;\n      default:\n        // If for some reason the `view` is not one of the allowed values, show nothing.\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Display the title for the current view. */}\n      <h1 className=\"text-3xl font-bold text-gray-800\">{viewTitles[view]}</h1>\n      {/* This is the main content box where the selected admin component will be rendered. */}\n      <div className=\"bg-white p-6 rounded-lg shadow-md min-h-[400px]\">\n        {renderContent()}\n      </div>\n    </div>\n  );\n};\n\nexport default AdminPanel;",
  "components/admin/AdminAcademicStructureTab.tsx": "/**\n * @file AdminAcademicStructureTab.tsx\n * @description\n * This component is the \"Academic Structure\" tab within the `AdminPanel`. It's a powerful\n * and complex page that allows an Administrator to define the entire academic hierarchy\n * of the institution.\n *\n * It is broken down into three main management sections:\n * 1.  **Manage Colleges**:\n *     - A form to add a new college.\n *     - A list of existing colleges with \"Edit\" and \"Delete\" buttons.\n * 2.  **Manage Programs**:\n *     - A form to add a new program and assign it to a college.\n *     - A list of existing programs with \"Edit\" and \"Delete\" buttons.\n * 3.  **Manage Batches**:\n *     - A dropdown to select a program.\n *     - A form to add a new batch (e.g., \"2025-2029\") to the selected program. The end year\n *       is automatically calculated based on the program's duration.\n *     - A list of existing batches for that program with \"Delete\" buttons.\n *\n * All create, update, and delete operations happen immediately (they do not use a \"draft state\").\n * It uses confirmation modals for all delete operations to prevent accidental data loss.\n */\n\nimport React, { useState, useMemo } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\nimport { College, Program, Batch } from '../../types';\nimport { Trash2, Edit } from '../Icons';\nimport ConfirmationModal from '../ConfirmationModal';\n\nconst AdminAcademicStructureTab: React.FC = () => {\n    // Get all the data and tools from the \"magic backpack\".\n    const { data, setData } = useAppContext();\n\n    // --- State Management for Forms ---\n    // State for the \"Manage Colleges\" form. `editingCollege` remembers if we're editing an existing one.\n    const [collegeName, setCollegeName] = useState('');\n    const [editingCollege, setEditingCollege] = useState<typeof data.colleges[0] | null>(null);\n\n    // State for the \"Manage Programs\" form.\n    const [programName, setProgramName] = useState('');\n    const [programCollegeId, setProgramCollegeId] = useState<College | ''>('');\n    const [programDuration, setProgramDuration] = useState<number>(4);\n    const [editingProgram, setEditingProgram] = useState<Program | null>(null);\n\n    // State for the \"Manage Batches\" form.\n    const [selectedProgramIdForBatch, setSelectedProgramIdForBatch] = useState<string>('');\n    const [batchStartYear, setBatchStartYear] = useState<string>('');\n\n    // State for the \"Are you sure?\" confirmation popup.\n    const [confirmation, setConfirmation] = useState<{ isOpen: boolean, title: string, message: string, onConfirm: () => void } | null>(null);\n\n    // `useMemo` is a smart calculator that finds the batches for the program selected in the dropdown.\n    const batchesForSelectedProgram = useMemo(() => {\n        if (!selectedProgramIdForBatch) return [];\n        return data.batches.filter(b => b.programId === selectedProgramIdForBatch).sort((a,b) => b.name.localeCompare(a.name));\n    }, [data.batches, selectedProgramIdForBatch]);\n\n\n    // --- Handlers for College Management ---\n    const handleAddOrUpdateCollege = (e: React.FormEvent) => {\n        e.preventDefault();\n        if (editingCollege) { // If we are editing...\n            setData(prev => ({ ...prev, colleges: prev.colleges.map(c => c.id === editingCollege.id ? { ...c, name: collegeName } : c) }));\n            setEditingCollege(null);\n        } else { // If we are adding a new one...\n            const newCollege = { id: collegeName.toUpperCase().replace(/\\s/g, '') as College, name: collegeName };\n            setData(prev => ({ ...prev, colleges: [...prev.colleges, newCollege] }));\n        }\n        setCollegeName(''); // Reset the form.\n    };\n\n    const handleDeleteCollege = (collegeId: College) => {\n        // Open the confirmation popup before deleting.\n        setConfirmation({\n            isOpen: true, title: \"Delete College\", message: \"Are you sure? Deleting a college will also delete all its programs and associated data.\",\n            onConfirm: () => {\n                // This is where the actual deletion happens, after user confirmation.\n                // NOTE: In a real app with a database, this would be a \"cascading delete\".\n                setData(prev => ({ ...prev, colleges: prev.colleges.filter(c => c.id !== collegeId) }));\n                setConfirmation(null);\n            }\n        });\n    };\n\n    // --- Handlers for Program Management ---\n    const handleAddOrUpdateProgram = (e: React.FormEvent) => { /* ... similar logic to colleges ... */ };\n    const handleDeleteProgram = (programId: string) => { /* ... similar logic with confirmation ... */ };\n\n    // --- Handlers for Batch Management ---\n    const handleAddBatch = (e: React.FormEvent) => {\n        e.preventDefault();\n        const program = data.programs.find(p => p.id === selectedProgramIdForBatch);\n        if (!program || !batchStartYear) return;\n        \n        // Calculate the batch name (e.g., \"2025-2029\") from the start year and program duration.\n        const startYearNum = parseInt(batchStartYear, 10);\n        const endYear = startYearNum + program.duration;\n        const batchName = `${startYearNum}-${endYear}`;\n\n        // Check for duplicates before adding.\n        if (data.batches.some(b => b.programId === program.id && b.name === batchName)) {\n            alert(`Batch ${batchName} already exists for this program.`); return;\n        }\n        // Create the new batch and add it to the main data.\n        const newBatch: Batch = { id: `B_${program.id}_${startYearNum}`, programId: program.id, name: batchName };\n        setData(prev => ({ ...prev, batches: [...prev.batches, newBatch] }));\n        setBatchStartYear(''); // Reset the form.\n    };\n\n    const handleDeleteBatch = (batchId: string) => { /* ... similar logic with confirmation ... */ };\n\n\n    return (\n        <div className=\"space-y-8\">\n            {/* Section 1: College Management */}\n            <section>\n                <h3 className=\"text-xl font-semibold text-gray-700 mb-4\">Manage Colleges</h3>\n                {/* ... Form and list for colleges ... */}\n            </section>\n\n            {/* Section 2: Program Management */}\n            <section>\n                <h3 className=\"text-xl font-semibold text-gray-700 mb-4\">Manage Programs</h3>\n                {/* ... Form and list for programs ... */}\n            </section>\n            \n            {/* Section 3: Batch Management */}\n            <section>\n                <h3 className=\"text-xl font-semibold text-gray-700 mb-4\">Manage Batches</h3>\n                {/* ... Dropdown, form, and list for batches ... */}\n            </section>\n\n            {/* The confirmation modal is only rendered if it has been activated. */}\n            {confirmation?.isOpen && (\n                <ConfirmationModal isOpen={confirmation.isOpen} title={confirmation.title} message={confirmation.message} onConfirm={confirmation.onConfirm} onClose={() => setConfirmation(null)}/>\n            )}\n        </div>\n    );\n};\n\nexport default AdminAcademicStructureTab;",
  "components/admin/AdminUserManagementTab.tsx": "/**\n * @file AdminUserManagementTab.tsx\n * @description\n * This component is the \"User Management\" tab within the `AdminPanel`. It's the main\n * interface for an Administrator to view, create, edit, and delete all user accounts\n * in the system.\n *\n * What it does:\n * 1.  **Displays All Users**: It shows a table with every user in the system.\n * 2.  **Search and Filter**: It provides a search bar to quickly find users by name, username,\n *     role, or employee ID.\n * 3.  **Displays Assignments**: For each user, it shows what they are assigned to (e.g., a PC's\n *     program, a Department Head's college), making it easy to see the hierarchy at a glance.\n * 4.  **Triggers User Editing**: It has \"Add New User\" and \"Edit\" buttons. When clicked,\n *     these buttons don't show a form directly. Instead, they open the `UserEditModal`\n *     component, which contains the actual form for creating or editing a user. This keeps\n *     this component's code focused on just displaying the list.\n * 5.  **Handles Deletion**: It provides a \"Delete\" button for each user, which uses a\n *     confirmation modal to prevent accidental deletion.\n */\n\nimport React, { useState, useMemo } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\nimport { User } from '../../types';\nimport UserEditModal from './UserEditModal';\nimport { Edit, Trash2 } from '../Icons';\nimport ConfirmationModal from '../ConfirmationModal';\n\nconst AdminUserManagementTab: React.FC = () => {\n  // Get all data and tools from the \"magic backpack\".\n  const { data, setData } = useAppContext();\n  \n  // --- State Management ---\n  // `isModalOpen` remembers if the Add/Edit User popup is visible.\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  // `editingUser` remembers which user is being edited (or is `null` if we're adding a new one).\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  // `searchTerm` remembers what the user has typed in the search bar.\n  const [searchTerm, setSearchTerm] = useState('');\n  // State for the \"Are you sure?\" confirmation popup.\n  const [confirmation, setConfirmation] = useState<{ isOpen: boolean, title: string, message: string, onConfirm: () => void } | null>(null);\n\n  // `useMemo` is a smart calculator that filters the user list based on the search term.\n  const filteredUsers = useMemo(() => {\n    if (!searchTerm) return data.users;\n    const lowercasedTerm = searchTerm.toLowerCase();\n    return data.users.filter(u =>\n      u.name.toLowerCase().includes(lowercasedTerm) ||\n      u.username.toLowerCase().includes(lowercasedTerm) ||\n      u.role.toLowerCase().includes(lowercasedTerm) ||\n      u.employeeId.toLowerCase().includes(lowercasedTerm)\n    );\n  }, [data.users, searchTerm]);\n\n  // This runs when the \"Add New User\" button is clicked.\n  const handleAddNew = () => {\n    setEditingUser(null); // Set to null to tell the modal we're in \"create\" mode.\n    setIsModalOpen(true); // Open the modal.\n  };\n\n  // This runs when an \"Edit\" button is clicked.\n  const handleEdit = (user: User) => {\n    setEditingUser(user); // Pass the user's data to the modal.\n    setIsModalOpen(true);\n  };\n\n  // This runs when a \"Delete\" button is clicked.\n  const handleDelete = (userId: string) => {\n    // It opens the confirmation popup first.\n    setConfirmation({\n        isOpen: true, title: \"Delete User\", message: \"Are you sure? This cannot be undone.\",\n        onConfirm: () => {\n            // The actual deletion only happens if the user confirms.\n            setData(prev => ({ ...prev, users: prev.users.filter(u => u.id !== userId) }));\n            setConfirmation(null);\n        }\n    });\n  };\n\n  /**\n   * A helper function to get a user-friendly string describing what a user is assigned to.\n   */\n  const getAssignmentInfo = (user: User): string => {\n      switch (user.role) {\n          case 'Department':\n              // For a Department Head, find and display the full name of their assigned college.\n              return data.colleges.find(c => c.id === user.collegeId)?.name || 'N/A';\n          case 'Program Co-ordinator':\n              // For a PC, find and display the name of the Department Head they report to.\n              const deptHead = data.users.find(u => u.id === user.departmentId);\n              return deptHead ? `Dept: ${deptHead.name}` : 'N/A';\n          case 'Teacher':\n              // For a teacher, find the names of all the PCs they report to.\n              const pcNames = user.programCoordinatorIds?.map(pcId => data.users.find(u => u.id === pcId)?.name).filter(Boolean).join(', ');\n              return pcNames || 'N/A';\n          default: \n              return 'N/A';\n      }\n  };\n\n\n  return (\n    <div className=\"space-y-6\">\n        <div className=\"flex justify-between items-center\">\n            <input type=\"text\" placeholder=\"Search by name, username, role, or ID...\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className=\"w-full max-w-sm p-2 border border-gray-300 rounded-md\"/>\n            <button onClick={handleAddNew} className=\"bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700\">Add New User</button>\n        </div>\n\n        <div className=\"overflow-x-auto border border-gray-200 rounded-lg\">\n            <table className=\"min-w-full divide-y divide-gray-200\">\n                <thead className=\"bg-gray-50\">\n                    <tr>\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Name</th>\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Username</th>\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Role</th>\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Assignment</th>\n                        <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Actions</th>\n                    </tr>\n                </thead>\n                <tbody className=\"bg-white divide-y divide-gray-200\">\n                    {filteredUsers.map(user => (\n                        <tr key={user.id}>\n                            <td className=\"px-6 py-4 whitespace-nowrap\">\n                                <div className=\"text-sm font-medium text-gray-900\">{user.name}</div>\n                                <div className=\"text-sm text-gray-500\">{user.employeeId}</div>\n                            </td>\n                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{user.username}</td>\n                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{user.role}</td>\n                            <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                                {getAssignmentInfo(user)}\n                            </td>\n                            <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">\n                                <button onClick={() => handleEdit(user)} className=\"text-indigo-600 hover:text-indigo-900 p-1\"><Edit className=\"w-5 h-5\"/></button>\n                                <button onClick={() => handleDelete(user.id)} className=\"text-red-600 hover:text-red-900 ml-4 p-1\"><Trash2 className=\"w-5 h-5\"/></button>\n                            </td>\n                        </tr>\n                    ))}\n                </tbody>\n            </table>\n        </div>\n\n        {/* The UserEditModal is only rendered if `isModalOpen` is true. */}\n        {isModalOpen && (\n            <UserEditModal userToEdit={editingUser} onClose={() => setIsModalOpen(false)} />\n        )}\n        {/* The ConfirmationModal is only rendered if `confirmation` is not null. */}\n        {confirmation?.isOpen && (\n            <ConfirmationModal isOpen={confirmation.isOpen} title={confirmation.title} message={confirmation.message} onConfirm={confirmation.onConfirm} onClose={() => setConfirmation(null)}/>\n        )}\n    </div>\n  );\n};\n\nexport default AdminUserManagementTab;",
  "components/admin/AdminSystemSettingsTab.tsx": "/**\n * @file AdminSystemSettingsTab.tsx\n * @description\n * This component is the \"System Settings\" tab within the `AdminPanel`. It allows an\n * Administrator to configure system-wide default values that affect various calculations\n * and new items created throughout the application.\n *\n * For example, when a new course is created, it will use the default values set here\n * for its attainment targets and thresholds.\n *\n * What it does:\n * 1.  **Displays Default Settings**: It shows forms for settings like:\n *     - Default CO Attainment Target.\n *     - Default Attainment Level Thresholds.\n *     - Default weights for Direct vs. Indirect PO attainment.\n * 2.  **Uses a \"Draft State\"**: Like other management screens, it uses a \"draft state\".\n *     When the Admin changes a value, it's not saved immediately. The `SaveBar` appears,\n *     allowing the Admin to save all changes at once or cancel them.\n */\n\nimport React, { useState, useMemo, useEffect } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\nimport { SystemSettings } from '../../types';\nimport SaveBar from '../SaveBar';\n\nconst AdminSystemSettingsTab: React.FC = () => {\n    // Get the main app data and tools from the \"magic backpack\".\n    const { data, setData } = useAppContext();\n    \n    // --- Draft State Management ---\n    // `draftSettings` is the temporary copy of the settings we make changes to.\n    const [draftSettings, setDraftSettings] = useState<SystemSettings>(data.settings);\n    // `initialSettings` is the saved version, used for comparison.\n    const [initialSettings, setInitialSettings] = useState<SystemSettings>(data.settings);\n\n    // This `useEffect` hook ensures our component's state is up-to-date if the global data ever changes.\n    useEffect(() => {\n        setDraftSettings(data.settings);\n        setInitialSettings(data.settings);\n    }, [data.settings]);\n\n    // `isDirty` checks if there are any unsaved changes.\n    const isDirty = useMemo(() => JSON.stringify(draftSettings) !== JSON.stringify(initialSettings), [draftSettings, initialSettings]);\n\n    // --- Handlers for Form Inputs ---\n    // A generic handler for simple input fields.\n    const handleInputChange = (field: keyof SystemSettings, value: number) => {\n        setDraftSettings(prev => ({ ...prev, [field]: value }));\n    };\n\n    // A specific handler for the nested \"Attainment Levels\" object.\n    const handleLevelChange = (level: keyof SystemSettings['defaultAttainmentLevels'], value: number) => {\n        setDraftSettings(prev => ({\n            ...prev,\n            defaultAttainmentLevels: { ...prev.defaultAttainmentLevels, [level]: value }\n        }));\n    };\n\n    // A handler for the \"Weights\" inputs, which ensures they always add up to 100.\n    const handleWeightChange = (type: 'direct' | 'indirect', value: number) => {\n        if (value < 0 || value > 100) return; // Basic validation.\n        setDraftSettings(prev => ({\n            ...prev,\n            defaultWeights: {\n                direct: type === 'direct' ? value : 100 - value,\n                indirect: type === 'indirect' ? value : 100 - value,\n            }\n        }));\n    };\n\n    // --- Handlers for the SaveBar ---\n    const handleSave = () => {\n        // Update the main application data in the \"magic backpack\".\n        setData(prev => ({ ...prev, settings: draftSettings }));\n        // The draft is now the new \"saved\" state.\n        setInitialSettings(draftSettings);\n        alert('System settings saved successfully!');\n    };\n\n    const handleCancel = () => {\n        // Discard all changes by resetting the draft to the initial state.\n        setDraftSettings(initialSettings);\n    };\n\n    return (\n        // `pb-20` adds padding at the bottom so the SaveBar doesn't cover content.\n        <div className=\"space-y-8 pb-20\">\n            <h2 className=\"text-xl font-semibold text-gray-700\">Default System Settings</h2>\n            \n            {/* Form section for Default CO Attainment Target */}\n            <div className=\"space-y-4 max-w-lg\">\n              {/* ... */}\n            </div>\n\n            {/* Form section for Default Attainment Level Thresholds */}\n            <div className=\"space-y-4\">\n              {/* ... */}\n            </div>\n\n            {/* Form section for Default Direct/Indirect Weights */}\n            <div className=\"space-y-4\">\n              {/* ... */}\n            </div>\n\n            {/* The SaveBar only appears if `isDirty` is true. */}\n            <SaveBar isDirty={isDirty} onSave={handleSave} onCancel={handleCancel} />\n        </div>\n    );\n};\n\nexport default AdminSystemSettingsTab;",
  "components/admin/UserEditModal.tsx": "/**\n * @file UserEditModal.tsx\n * @description\n * This component is a popup window (\"modal\") that contains a form for either creating\n * a new user or editing an existing one. It's used by the `AdminUserManagementTab`.\n *\n * It's a highly dynamic form that changes its appearance based on the user's role.\n *\n * What it does:\n * 1.  **Dual Mode (Create/Edit)**: It checks if a `userToEdit` prop was passed to it.\n *     - If `userToEdit` exists, it pre-fills the form with that user's data for editing.\n *     - If `userToEdit` is `null`, it shows a blank form for creating a new user.\n * 2.  **Manages Form State**: It uses a single `user` object in its state to keep track\n *     of all the data being entered into the form fields.\n * 3.  **Conditional Fields**: It shows and hides certain form fields based on the selected\n *     \"Role\". For example, if the role is \"Department\", it shows a dropdown to assign them\n *     to a College. If the role is \"Teacher\", it shows a multi-select box to assign them\n *     to Program Co-ordinators.\n * 4.  **Handles Submission**: When the form is submitted, it performs validation and then\n *     updates the main application data in the \"magic backpack\" by either adding a new\n *     user or updating an existing one.\n */\n\nimport React, { useState } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\nimport { User, Role, College } from '../../types';\nimport Modal from '../Modal';\n\n// This defines the \"props\" or properties this component accepts.\ninterface UserEditModalProps {\n  userToEdit: User | null; // The user to edit, or null if creating a new one.\n  onClose: () => void; // A function to close the modal.\n}\n\nconst UserEditModal: React.FC<UserEditModalProps> = ({ userToEdit, onClose }) => {\n    // Get all data and tools from the \"magic backpack\".\n    const { data, setData } = useAppContext();\n    \n    // --- State Management for the Form ---\n    // We initialize our component's memory (`user` state) with the data from `userToEdit`\n    // if it exists, or with default empty values if we're creating a new user.\n    const [user, setUser] = useState<Partial<User>>({\n        id: userToEdit?.id || `U_${Date.now()}`, // Use existing ID or create a new one.\n        employeeId: userToEdit?.employeeId || '', \n        name: userToEdit?.name || '',\n        username: userToEdit?.username || '', \n        password: '', // Password is always blank for security.\n        role: userToEdit?.role || 'Teacher',\n        collegeId: userToEdit?.collegeId, \n        departmentId: userToEdit?.departmentId,\n        programId: userToEdit?.programId, \n        programCoordinatorIds: userToEdit?.programCoordinatorIds || [],\n        status: userToEdit?.status || 'Active'\n    });\n\n    const roles: Role[] = ['Teacher', 'Program Co-ordinator', 'Department', 'University', 'Admin'];\n\n    // A generic handler to update our `user` state when any input changes.\n    const handleInputChange = (field: keyof User, value: any) => {\n        const newUserState = { ...user, [field]: value };\n        // When the role changes, we clear out all the role-specific assignment fields\n        // to prevent inconsistent data.\n        if (field === 'role') {\n            newUserState.collegeId = undefined;\n            newUserState.departmentId = undefined;\n            newUserState.programId = undefined;\n            newUserState.programCoordinatorIds = [];\n        }\n        setUser(newUserState);\n    };\n    \n    // A specific handler for the multi-select dropdown used for assigning teachers.\n    const handleMultiSelectChange = (field: keyof User, selectedOptions: string[]) => {\n         setUser(prev => ({...prev, [field]: selectedOptions}));\n    };\n\n    // This runs when the form is submitted.\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n\n        // Basic validation.\n        if (!user.name || !user.username || !user.employeeId || (!userToEdit && !user.password)) {\n            alert('Please fill all required fields, including password for new users.'); return;\n        }\n\n        setData(prev => {\n            const userExists = prev.users.some(u => u.id === user.id);\n            if (userExists) { // If the user already exists, we update them.\n                return { \n                    ...prev, \n                    users: prev.users.map(u => \n                        u.id === user.id \n                        // We merge the old user data with the new, and only update the password if a new one was typed.\n                        ? { ...u, ...user, password: user.password || u.password } as User\n                        : u\n                    ) \n                };\n            } else { // Otherwise, we add them as a new user.\n                return { ...prev, users: [...prev.users, user as User] };\n            }\n        });\n        onClose(); // Close the modal.\n    };\n    \n    // Get lists of Department Heads and PCs for the assignment dropdowns.\n    const departmentHeads = data.users.filter(u => u.role === 'Department');\n    const programCoordinators = data.users.filter(u => u.role === 'Program Co-ordinator');\n\n    return (\n        <Modal title={userToEdit ? 'Edit User' : 'Add New User'} onClose={onClose}>\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-4 max-h-[80vh] overflow-y-auto\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <input type=\"hidden\" value={user.id} />\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Full Name</label><input type=\"text\" value={user.name} onChange={e => handleInputChange('name', e.target.value)} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\" required /></div>\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Employee ID</label><input type=\"text\" value={user.employeeId} onChange={e => handleInputChange('employeeId', e.target.value)} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\" required /></div>\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Username</label><input type=\"text\" value={user.username} onChange={e => handleInputChange('username', e.target.value)} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\" required /></div>\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Password</label><input type=\"password\" value={user.password} onChange={e => handleInputChange('password', e.target.value)} placeholder={userToEdit ? 'Leave blank to keep unchanged' : ''} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\" required={!userToEdit} /></div>\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Role</label><select value={user.role} onChange={e => handleInputChange('role', e.target.value as Role)} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\">{roles.map(r => <option key={r} value={r}>{r}</option>)}</select></div>\n                    <div><label className=\"block text-sm font-medium text-gray-700\">Status</label><select value={user.status} onChange={e => handleInputChange('status', e.target.value as 'Active' | 'Inactive')} className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500\"><option value=\"Active\">Active</option><option value=\"Inactive\">Inactive</option></select></div>\n                </div>\n\n                {/* --- Role-specific assignment fields (conditionally rendered) --- */}\n                {user.role === 'Department' && (\n                     <div>\n                        <label className=\"block text-sm font-medium text-gray-700\">Assigned College</label>\n                        <select\n                            value={user.collegeId || ''}\n                            onChange={(e) => handleInputChange('collegeId', e.target.value as College)}\n                            className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500\"\n                        >\n                            <option value=\"\">-- Unassigned --</option>\n                            {data.colleges.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\n                        </select>\n                    </div>\n                )}\n                {user.role === 'Program Co-ordinator' && (\n                     <div>\n                        <label className=\"block text-sm font-medium text-gray-700\">Reports to (Department Head)</label>\n                        <select\n                            value={user.departmentId || ''}\n                            onChange={(e) => handleInputChange('departmentId', e.target.value)}\n                            className=\"mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500\"\n                        >\n                            <option value=\"\">-- Unassigned --</option>\n                            {departmentHeads.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}\n                        </select>\n                    </div>\n                )}\n                 {user.role === 'Teacher' && (\n                     <div>\n                        <label className=\"block text-sm font-medium text-gray-700\">Reports to (Program Co-ordinator)</label>\n                        <select\n                            multiple\n                            value={user.programCoordinatorIds || []}\n                            onChange={(e) => handleMultiSelectChange('programCoordinatorIds', Array.from(e.target.selectedOptions, option => option.value))}\n                            className=\"mt-1 block w-full h-24 bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500\"\n                        >\n                           {programCoordinators.map(pc => <option key={pc.id} value={pc.id}>{pc.name}</option>)}\n                        </select>\n                        <p className=\"text-xs text-gray-500 mt-1\">Hold Ctrl or Cmd to select multiple.</p>\n                    </div>\n                )}\n\n                <div className=\"flex justify-end pt-4 gap-3\">\n                    <button type=\"button\" onClick={onClose} className=\"bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg\">Cancel</button>\n                    <button type=\"submit\" className=\"bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg\">{userToEdit ? 'Save Changes' : 'Create User'}</button>\n                </div>\n            </form>\n        </Modal>\n    );\n};\n\nexport default UserEditModal;",
  "components/CoursePoLinkageDashboard.tsx": "/**\n * @file CoursePoLinkageDashboard.tsx\n * @description\n * This component is a dashboard displayed on the `ProgramOutcomesList` page. Its purpose is to\n * show how each course in a program contributes to the Program Outcomes (POs).\n *\n * It performs two main calculations:\n * 1.  **Overall CO Attainment per Course**: For each course, it calculates the average\n *     attainment percentage across all its COs for all students in the selected batch. This\n *     gives a single performance score for the entire course.\n * 2.  **Average Linkage to POs**: For each course, it looks at the CO-PO Mapping Matrix\n *     and calculates the average mapping strength (from 0 to 3) from that course to each PO.\n *     This shows how strongly a course is designed to support each program outcome.\n *\n * The result is a table with courses as rows and POs as columns, providing a high-level\n * overview of the curriculum's structure and performance.\n */\n\nimport React, { useMemo } from 'react';\nimport { ProgramOutcome, Course } from '../types';\nimport { useAppContext } from '../hooks/useAppContext';\n\n// This defines the \"props\" or properties that this component accepts from its parent.\ninterface CoursePoLinkageDashboardProps {\n    programOutcomes: ProgramOutcome[];\n    courses: Course[];\n}\n\nconst CoursePoLinkageDashboard: React.FC<CoursePoLinkageDashboardProps> = ({ programOutcomes, courses }) => {\n    // We get our app's data and the selected batch from the \"magic backpack\".\n    const { data, selectedBatch } = useAppContext();\n\n    /**\n     * This is the main calculation logic for the dashboard, wrapped in `useMemo` for performance.\n     * It will only re-run if its dependencies (courses, data, selectedBatch) change.\n     */\n    const courseLinkageData = useMemo(() => {\n        if (!selectedBatch || courses.length === 0) return [];\n        const programId = courses[0].programId;\n\n        // --- Step 1: Filter students down to the selected batch. ---\n        const batch = data.batches.find(b => b.programId === programId && b.name === selectedBatch);\n        if (!batch) return [];\n        const sectionIdsForBatch = new Set(data.sections.filter(s => s.batchId === batch.id).map(s => s.id));\n\n        // --- Step 2: Pre-calculate lookup maps for performance. ---\n        // This is much faster than searching through arrays inside a loop.\n        \n        // Map of student marks: Student ID -> Assessment ID -> Question Name -> Marks\n        const studentMarksMap = new Map<string, Map<string, Map<string, number>>>();\n        data.marks.forEach(mark => {\n            if (!studentMarksMap.has(mark.studentId)) studentMarksMap.set(mark.studentId, new Map());\n            const assessmentMap = studentMarksMap.get(mark.studentId)!;\n            assessmentMap.set(mark.assessmentId, new Map(mark.scores.map(s => [s.q, s.marks])));\n        });\n\n        // Map of which questions belong to which CO: CO ID -> [List of Questions]\n        const coQuestionMap = new Map<string, { q: string; maxMarks: number; assessmentId: string }[]>();\n        data.courseOutcomes.forEach(co => coQuestionMap.set(co.id, []));\n        data.assessments.forEach(a => a.questions.forEach(q => q.coIds.forEach(coId => coQuestionMap.get(coId)?.push({ ...q, assessmentId: a.id }))));\n\n\n        // --- Step 3: Loop through each course to calculate its data row. ---\n        return courses.map(course => {\n            const courseOutcomes = data.courseOutcomes.filter(co => co.courseId === course.id);\n            \n            // Find all students who are enrolled in this course AND belong to the selected batch.\n            const studentsInCourse = data.students.filter(s => \n                s.sectionId && sectionIdsForBatch.has(s.sectionId) &&\n                data.enrollments.some(e => e.studentId === s.id && e.courseId === course.id)\n            );\n\n            // --- Calculation Part A: Overall CO Attainment for the course ---\n            let overallCoAttainment = 0;\n            if (studentsInCourse.length > 0 && courseOutcomes.length > 0) {\n                // To get the course's overall attainment, we first calculate the average\n                // attainment for each individual student in the course...\n                const studentOverallAttainments = studentsInCourse.map(student => {\n                    const studentCoPercentages = courseOutcomes.map(co => {\n                        const questionsForCo = coQuestionMap.get(co.id) || [];\n                        if (questionsForCo.length === 0) return 0;\n                        \n                        const totalMaxMarks = questionsForCo.reduce((sum, q) => sum + q.maxMarks, 0);\n                        let totalObtainedMarks = 0;\n\n                        const studentAllMarks = studentMarksMap.get(student.id);\n                        if (studentAllMarks) {\n                            totalObtainedMarks = questionsForCo.reduce((sum, q) => {\n                                const marks = studentAllMarks.get(q.assessmentId)?.get(q.q);\n                                return sum + (marks || 0);\n                            }, 0);\n                        }\n\n                        return totalMaxMarks > 0 ? (totalObtainedMarks / totalMaxMarks) * 100 : 0;\n                    });\n                    \n                    // ...calculate the student's personal average across all COs...\n                    return studentCoPercentages.length > 0 ? studentCoPercentages.reduce((a, b) => a + b, 0) / studentCoPercentages.length : 0;\n                });\n                // ...and finally, we average all the student averages to get the course's overall score.\n                overallCoAttainment = studentOverallAttainments.length > 0 ? studentOverallAttainments.reduce((a,b) => a+b, 0) / studentOverallAttainments.length : 0;\n            }\n\n            // --- Calculation Part B: Average Linkage Level from this course to each PO ---\n            const averageLinkages: { [poId: string]: number } = {};\n            programOutcomes.forEach(po => {\n                if (courseOutcomes.length === 0) { averageLinkages[po.id] = 0; return; }\n\n                let totalLinkageLevel = 0;\n                let linkedCoCount = 0;\n\n                courseOutcomes.forEach(co => {\n                    // Find the mapping strength (1, 2, or 3) from this CO to the current PO.\n                    const mapping = data.coPoMapping.find(m => m.courseId === course.id && m.coId === co.id && m.poId === po.id);\n                    const level = mapping?.level || 0;\n                    if (level > 0) {\n                        totalLinkageLevel += level;\n                        linkedCoCount++;\n                    }\n                });\n\n                // The average is the total strength divided by the number of COs that actually map to the PO.\n                averageLinkages[po.id] = linkedCoCount > 0 ? totalLinkageLevel / linkedCoCount : 0;\n            });\n            \n            return { course, overallCoAttainment, averageLinkages };\n        });\n\n    }, [courses, programOutcomes, data, selectedBatch]);\n\n\n    if (courses.length === 0) return null;\n\n    return (\n        <div className=\"bg-white p-6 rounded-lg shadow-md\">\n            <h2 className=\"text-2xl font-bold text-gray-800 mb-6\">Course Contribution to POs</h2>\n            <div className=\"overflow-x-auto\">\n                <table className=\"min-w-full border-collapse border border-gray-300\">\n                    <thead className=\"bg-gray-50\">\n                        <tr>\n                            <th className=\"border border-gray-300 p-2 text-sm font-medium text-gray-500 uppercase\">Course</th>\n                            <th className=\"border border-gray-300 p-2 text-sm font-medium text-gray-500 uppercase\">Overall CO Attainment</th>\n                            {programOutcomes.map(po => (\n                                <th key={po.id} className=\"border border-gray-300 p-2 text-sm font-medium text-gray-500 uppercase\" title={po.description}>{po.number} Linkage</th>\n                            ))}\n                        </tr>\n                    </thead>\n                    <tbody>\n                        {/* We loop through our calculated data to build the table rows. */}\n                        {courseLinkageData.map(({ course, overallCoAttainment, averageLinkages }) => (\n                            <tr key={course.id} className=\"bg-white hover:bg-gray-50\">\n                                <td className=\"border border-gray-300 p-2 font-semibold text-gray-700\">{course.name} ({course.code})</td>\n                                <td className=\"border border-gray-300 p-2 text-center\">\n                                    {/* The overall attainment score for the course. */}\n                                    <span className={`font-bold px-2 py-1 rounded-md ${overallCoAttainment >= course.target ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>\n                                        {overallCoAttainment.toFixed(1)}%\n                                    </span>\n                                </td>\n                                {/* The average linkage level from this course to each PO. */}\n                                {programOutcomes.map(po => (\n                                    <td key={po.id} className=\"border border-gray-300 p-2 text-center text-gray-600\">\n                                        {averageLinkages[po.id].toFixed(2)}\n                                    </td>\n                                ))}\n                            </tr>\n                        ))}\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    );\n};\n\nexport default CoursePoLinkageDashboard;",
  "components/TeacherDashboard.tsx": "/**\n * @file TeacherDashboard.tsx\n * @description\n * This is a specialized dashboard component designed exclusively for users with the 'Teacher' role.\n * It provides a personalized, at-a-glance overview of a teacher's responsibilities.\n *\n * What it does:\n * 1.  **Personalized Welcome**: Displays a welcome message with the teacher's name.\n * 2.  **Task Overview**: Includes a placeholder section for \"Upcoming Deadlines & Tasks\" to help\n *     teachers stay organized.\n * 3.  **Assigned Courses**: The main feature is a list of all courses the teacher is assigned to.\n *     For each course, it shows:\n *     - The course name and code.\n *     - A summary of the status of all its assessments (e.g., \"Marks Uploaded\" or \"Pending\").\n *     - A convenient \"Manage Course\" link to navigate directly to the `CourseDetail` page.\n */\n\nimport React, { useMemo } from 'react';\nimport { Link } from 'react-router-dom';\nimport { useAppContext } from '../hooks/useAppContext';\nimport { BookOpen } from './Icons'; // Import an icon for the course cards.\n\n// This is the main component function for the Teacher's Dashboard.\nconst TeacherDashboard: React.FC = () => {\n    // We get the current user and all application data from our \"magic backpack\".\n    const { currentUser, data } = useAppContext();\n\n    /**\n     * `useMemo` is a performance helper, like a smart calculator. It calculates the teacher's\n     * course data and only re-runs the calculation if the data or the teacher changes.\n     */\n    const assignedCoursesData = useMemo(() => {\n        if (!currentUser || currentUser.role !== 'Teacher') return [];\n        \n        // --- Step 1: Find all courses this teacher is assigned to. ---\n        // This includes being the main teacher (`teacherId`) or a section-specific teacher (`sectionTeacherIds`).\n        const courses = data.courses.filter(c =>\n            c.teacherId === currentUser.id ||\n            (c.sectionTeacherIds && Object.values(c.sectionTeacherIds).includes(currentUser.id))\n        );\n\n        // --- Step 2: For each course, create a summary of its assessment status. ---\n        return courses.map(course => {\n            // Find all sections that have students enrolled in this course.\n            const sectionIdsForCourse = new Set(data.enrollments.filter(e => e.courseId === course.id && e.sectionId).map(e => e.sectionId!));\n            \n            // Find all assessments associated with those sections.\n            const assessments = data.assessments\n                .filter(a => sectionIdsForCourse.has(a.sectionId))\n                .map(assessment => ({\n                    ...assessment,\n                    // For each assessment, check if any marks have been uploaded for it.\n                    hasMarks: data.marks.some(m => m.assessmentId === assessment.id)\n                }));\n\n            return {\n                ...course,\n                assessments,\n            };\n        });\n    }, [data, currentUser]);\n\n    // The JSX below describes what the Teacher Dashboard looks like.\n    return (\n        <div className=\"space-y-6\">\n            <div>\n                <h1 className=\"text-3xl font-bold text-gray-800\">Welcome, {currentUser?.name}</h1>\n                <p className=\"text-gray-500 mt-1\">Here's your overview for today.</p>\n            </div>\n            \n            {/* Placeholder section for upcoming tasks or deadlines. */}\n            <div className=\"bg-white p-6 rounded-lg shadow-md\">\n                <h2 className=\"text-xl font-semibold text-gray-700 mb-4\">Upcoming Deadlines & Tasks</h2>\n                <div className=\"text-center py-4\">\n                    <p className=\"text-gray-500\">No upcoming tasks. You're all caught up!</p>\n                </div>\n            </div>\n\n            {/* Main section for displaying assigned courses. */}\n            <div className=\"bg-white p-6 rounded-lg shadow-md\">\n                <h2 className=\"text-xl font-semibold text-gray-700 mb-4 flex items-center\">\n                    <BookOpen className=\"w-6 h-6 mr-3 text-blue-500\" /> My Assigned Courses\n                </h2>\n                <div className=\"space-y-4\">\n                    {/* We loop through the course data we calculated and create a card for each course. */}\n                    {assignedCoursesData.map(course => (\n                        <div key={course.id} className=\"bg-gray-50 p-4 rounded-lg border border-gray-200\">\n                            <div className=\"flex justify-between items-start\">\n                                <div>\n                                    <h3 className=\"text-lg font-bold text-gray-800\">{course.name} ({course.code})</h3>\n                                </div>\n                                {/* The \"Manage Course\" link navigates the user to the detailed course page. */}\n                                <Link to={`/courses/${course.id}`} className=\"bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold text-sm\">\n                                    Manage Course\n                                </Link>\n                            </div>\n                            <div className=\"mt-3 border-t pt-3\">\n                                <h4 className=\"text-sm font-semibold text-gray-600 mb-2\">Assessment Status</h4>\n                                <div className=\"space-y-1\">\n                                    {/* For each assessment in the course, show its name and status. */}\n                                    {course.assessments.map(assessment => (\n                                        <div key={assessment.id} className=\"flex justify-between items-center text-sm\">\n                                            <p className=\"text-gray-700\">{assessment.name}</p>\n                                            <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${assessment.hasMarks ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>\n                                                {assessment.hasMarks ? 'Marks Uploaded' : 'Pending'}\n                                            </span>\n                                        </div>\n                                    ))}\n                                    {course.assessments.length === 0 && <p className=\"text-sm text-gray-500\">No assessments created for this course yet.</p>}\n                                </div>\n                            </div>\n                        </div>\n                    ))}\n                    {/* If the teacher has no courses, show a friendly message. */}\n                    {assignedCoursesData.length === 0 && (\n                        <div className=\"text-center py-4\">\n                            <p className=\"text-gray-500\">You have not been assigned to any courses yet.</p>\n                        </div>\n                    )}\n                </div>\n            </div>\n        </div>\n    );\n};\n\nexport default TeacherDashboard;",
  "components/PrintableReport.tsx": "/**\n * @file PrintableReport.tsx\n * @description\n * This component acts as a \"report preview\" modal. It takes any content (passed as `children`),\n * displays it in a clean format, and provides a \"Download PDF\" button.\n *\n * It uses the jsPDF and html2canvas libraries to:\n * 1. Capture the report content as a high-quality image.\n * 2. Create a multi-page PDF document.\n * 3. Add the captured image to the PDF, splitting it across pages if necessary.\n * 4. Trigger a download of the generated PDF file.\n */\n\nimport React, { useState } from 'react';\n\n// These lines tell TypeScript that we expect `jspdf` and `html2canvas` to be available\n// globally, as they are loaded from script tags in `index.html`.\ndeclare const jspdf: any;\ndeclare const html2canvas: any;\n\n\n// Defines the props this component accepts.\ninterface PrintableReportProps {\n  title: string;\n  onClose: () => void;\n  children: React.ReactNode;\n}\n\nconst PrintableReport: React.FC<PrintableReportProps> = ({ title, onClose, children }) => {\n  // A piece of memory to track whether the PDF is currently being generated.\n  const [isDownloading, setIsDownloading] = useState(false);\n\n  // This function handles the PDF generation and download.\n  const handleDownloadPdf = async () => {\n    // A safety check to ensure the required libraries are loaded.\n    if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {\n      alert('PDF generation libraries are not loaded. Please check your internet connection or script tags in index.html.');\n      return;\n    }\n\n    setIsDownloading(true); // Show the \"Downloading...\" message on the button.\n    const { jsPDF } = jspdf;\n    \n    // Find the HTML element that contains the report content we want to capture.\n    const reportElement = document.getElementById('report-content-to-download');\n    if (!reportElement) {\n        setIsDownloading(false);\n        return;\n    }\n\n    try {\n      // Use html2canvas to \"screenshot\" the report content at a higher resolution (scale: 2).\n      const canvas = await html2canvas(reportElement, { scale: 2 });\n      const imgData = canvas.toDataURL('image/png'); // Convert the canvas to a PNG image.\n\n      // Create a new PDF document in A4 size.\n      const pdf = new jsPDF({\n        orientation: 'portrait',\n        unit: 'mm',\n        format: 'a4'\n      });\n\n      // Calculate the dimensions of the image and the PDF page.\n      const pdfWidth = pdf.internal.pageSize.getWidth();\n      const pdfHeight = pdf.internal.pageSize.getHeight();\n      const imgWidth = canvas.width;\n      const imgHeight = canvas.height;\n      \n      // Calculate the ratio to maintain the image's aspect ratio when fitting it to the PDF width.\n      const ratio = imgWidth / imgHeight;\n      const widthInPdf = pdfWidth;\n      const heightInPdf = widthInPdf / ratio;\n\n      let position = 0;\n      let heightLeft = heightInPdf;\n\n      // Add the first page with the image.\n      pdf.addImage(imgData, 'PNG', 0, position, widthInPdf, heightInPdf);\n      heightLeft -= pdfHeight;\n\n      // If the report is taller than one page, add more pages.\n      while (heightLeft >= 0) {\n        position = heightLeft - heightInPdf; // Adjust the position to show the next part of the image.\n        pdf.addPage();\n        pdf.addImage(imgData, 'PNG', 0, position, widthInPdf, heightInPdf);\n        heightLeft -= pdfHeight;\n      }\n      \n      // Trigger the download of the PDF file.\n      pdf.save(`${title.replace(/\\s/g, '_')}.pdf`);\n\n    } catch (error) {\n        console.error(\"Error generating PDF:\", error);\n        alert(\"Sorry, there was an error generating the PDF.\");\n    } finally {\n        setIsDownloading(false); // Reset the button text.\n    }\n  };\n\n\n  return (\n    // The full-screen, semi-transparent background overlay. The `print:hidden` class ensures this doesn't show up on paper.\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 print:hidden\">\n      {/* The main white container for the report preview. */}\n      <div className=\"bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col\">\n        {/* Header with title and controls */}\n        <div className=\"flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0\">\n          <h3 className=\"text-xl font-semibold text-gray-800\">{title}</h3>\n          <div className=\"flex gap-4\">\n            <button\n              onClick={handleDownloadPdf}\n              disabled={isDownloading}\n              className=\"px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-wait\"\n            >\n              {isDownloading ? 'Downloading...' : 'Download PDF'}\n            </button>\n            <button\n              onClick={onClose}\n              className=\"px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300\"\n              aria-label=\"Close\"\n            >\n              Close\n            </button>\n          </div>\n        </div>\n        {/* The scrollable content area where the actual report is previewed on screen. */}\n        {/* We add an `id` here so that `html2canvas` knows exactly what to capture. */}\n        <div id=\"report-content-to-download\" className=\"flex-grow overflow-y-auto p-6 bg-white\">\n            {children}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default PrintableReport;",
  "components/reports/CourseAttainmentSummaryReport.tsx": "/**\n * @file CourseAttainmentSummaryReport.tsx\n * @description\n * This component generates the full, detailed \"Course Attainment Summary\" report.\n * It's designed to be displayed inside the `PrintableReport` previewer.\n *\n * What it does:\n * 1.  **Fetches and Calculates Data**: It performs all the complex calculations needed for the report,\n *     combining the logic from `CourseCoAttainment` and `StudentCOAttainmentReport`.\n * 2.  **Renders Header**: Displays a professional header with the university logo, report title,\n *     and all relevant details (program, course, teacher, etc.).\n * 3.  **Renders CO Summary**: Displays a table showing the final attainment level for each CO.\n * 4.  **Renders Student Breakdown**: Displays a detailed table showing every student's individual\n *     attainment percentage for every CO.\n */\n\nimport React, { useMemo } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\n\n// Defines the props this component accepts.\ninterface ReportProps {\n  courseId: string;\n  scopeId: string; // 'overall' or a section ID.\n}\n\nconst CourseAttainmentSummaryReport: React.FC<ReportProps> = ({ courseId, scopeId }) => {\n  // Get all data and user info from the \"magic backpack\".\n  const { data, currentUser, selectedProgram, selectedBatch } = useAppContext();\n\n  // `useMemo` is a smart calculator that performs all the complex data fetching and\n  // calculations for the report.\n  const {\n    course,\n    coAttainmentData,\n    studentAttainmentData,\n    scopeName,\n  } = useMemo(() => {\n    const course = data.courses.find(c => c.id === courseId);\n    if (!course) return { course: null, coAttainmentData: { results: [], studentCount: 0 }, studentAttainmentData: { students: [], courseOutcomes: [], reportData: new Map() }, scopeName: '' };\n    \n    // --- Step 1: Filter students based on the selected scope ('overall' or a section). ---\n    let studentsInScope;\n    if (scopeId === 'overall') {\n        const batch = data.batches.find(b => b.programId === course.programId && b.name === selectedBatch);\n        if (!batch) return { course: null, coAttainmentData: { results: [], studentCount: 0 }, studentAttainmentData: { students: [], courseOutcomes: [], reportData: new Map() }, scopeName: 'Overall' };\n        \n        const sectionIdsForBatch = new Set(data.sections.filter(s => s.batchId === batch.id).map(s => s.id));\n        const studentIdsInBatch = new Set(data.students.filter(s => s.sectionId && sectionIdsForBatch.has(s.sectionId)).map(s => s.id));\n        studentsInScope = data.students.filter(s => s.status === 'Active' && studentIdsInBatch.has(s.id) && data.enrollments.some(e => e.studentId === s.id && e.courseId === course.id));\n    } else {\n         studentsInScope = data.students.filter(s => s.status === 'Active' && s.sectionId === scopeId && data.enrollments.some(e => e.studentId === s.id && e.courseId === course.id));\n    }\n    const studentIdsInScope = new Set(studentsInScope.map(s => s.id));\n\n    // --- Step 2: Pre-calculate helper maps for performance. ---\n    const courseOutcomes = data.courseOutcomes.filter(co => co.courseId === course.id).sort((a,b) => a.number.localeCompare(b.number));\n    const sectionIdsForCourse = new Set(data.enrollments.filter(e => e.courseId === course.id && e.sectionId).map(e => e.sectionId!));\n    const assessmentsForCourse = data.assessments.filter(a => sectionIdsForCourse.has(a.sectionId));\n    \n    const studentMarksMap = new Map<string, Map<string, Map<string, number>>>();\n    data.marks.filter(m => studentIdsInScope.has(m.studentId)).forEach(mark => {\n        if (!studentMarksMap.has(mark.studentId)) studentMarksMap.set(mark.studentId, new Map());\n        const assessmentMap = studentMarksMap.get(mark.studentId)!;\n        assessmentMap.set(mark.assessmentId, new Map(mark.scores.map(s => [s.q, s.marks])));\n    });\n\n    const coQuestionMap = new Map<string, { q: string; maxMarks: number; assessmentId: string }[]>();\n    courseOutcomes.forEach(co => coQuestionMap.set(co.id, []));\n    assessmentsForCourse.forEach(a => a.questions.forEach(q => q.coIds.forEach(coId => coQuestionMap.get(coId)?.push({ ...q, assessmentId: a.id }))));\n    \n    // --- Step 3: Calculate Overall CO Attainment Summary (like in CourseCoAttainment.tsx) ---\n    const coAttainmentResults = courseOutcomes.map(co => {\n        const questionsForCo = coQuestionMap.get(co.id) || [];\n        if (questionsForCo.length === 0 || studentsInScope.length === 0) return { co, percentageMeetingTarget: 0, attainmentLevel: 0 };\n        \n        let studentsMeetingTarget = 0;\n        studentsInScope.forEach(student => {\n            const totalMaxCoMarks = questionsForCo.reduce((sum, q) => sum + q.maxMarks, 0);\n            const studentAllMarks = studentMarksMap.get(student.id);\n            let totalObtainedCoMarks = studentAllMarks ? questionsForCo.reduce((sum, q) => sum + (studentAllMarks.get(q.assessmentId)?.get(q.q) || 0), 0) : 0;\n            if (totalMaxCoMarks > 0 && (totalObtainedCoMarks / totalMaxCoMarks) * 100 >= course.target) {\n                studentsMeetingTarget++;\n            }\n        });\n        const percentageMeetingTarget = (studentsMeetingTarget / studentsInScope.length) * 100;\n        let attainmentLevel = 0;\n        if (percentageMeetingTarget >= course.attainmentLevels.level3) attainmentLevel = 3;\n        else if (percentageMeetingTarget >= course.attainmentLevels.level2) attainmentLevel = 2;\n        else if (percentageMeetingTarget >= course.attainmentLevels.level1) attainmentLevel = 1;\n        return { co, percentageMeetingTarget, attainmentLevel };\n    });\n\n    // --- Step 4: Calculate Student-wise Attainment (like in StudentCOAttainmentReport.tsx) ---\n    const studentReportData = new Map<string, { [coId: string]: number }>();\n    studentsInScope.forEach(student => {\n        const studentAttainment: { [coId: string]: number } = {};\n        courseOutcomes.forEach(co => {\n            const questionsForCo = coQuestionMap.get(co.id) || [];\n            const totalMaxCoMarks = questionsForCo.reduce((sum, q) => sum + q.maxMarks, 0);\n            const studentAllMarks = studentMarksMap.get(student.id);\n            let totalObtainedCoMarks = studentAllMarks ? questionsForCo.reduce((sum, q) => sum + (studentAllMarks.get(q.assessmentId)?.get(q.q) || 0), 0) : 0;\n            studentAttainment[co.id] = totalMaxCoMarks > 0 ? (totalObtainedCoMarks / totalMaxCoMarks) * 100 : 0;\n        });\n        studentReportData.set(student.id, studentAttainment);\n    });\n\n    const scopeNameText = scopeId === 'overall' ? 'Overall Course' : `Section ${data.sections.find(s => s.id === scopeId)?.name}`;\n\n    return {\n        course,\n        coAttainmentData: { results: coAttainmentResults, studentCount: studentsInScope.length },\n        studentAttainmentData: { students: studentsInScope.sort((a,b) => a.id.localeCompare(b.id)), courseOutcomes, reportData: studentReportData },\n        scopeName: scopeNameText,\n    };\n  }, [data, courseId, scopeId, selectedBatch, currentUser]);\n  \n  if (!course) return <p className=\"text-red-500\">Course not found.</p>;\n\n  const attainmentLevelColors: { [key: number]: string } = {\n      3: 'bg-green-100 text-green-800', 2: 'bg-blue-100 text-blue-800',\n      1: 'bg-yellow-100 text-yellow-800', 0: 'bg-red-100 text-red-800',\n  };\n\n  return (\n    <div className=\"space-y-8 text-sm\">\n        {/* Report Header */}\n        <div className=\"mb-8 pb-4 border-b-2 border-gray-800\">\n            <div className=\"flex justify-between items-center\">\n                <div>\n                    <h1 className=\"text-2xl font-bold text-gray-800\">Course Attainment Summary</h1>\n                    <p className=\"text-gray-600\">Generated on: {new Date().toLocaleDateString()}</p>\n                </div>\n                <img src=\"https://d1hbpr09pwz0sk.cloudfront.net/logo_url/chitkara-university-4c35e411\" alt=\"Logo\" className=\"h-16\" />\n            </div>\n            <div className=\"mt-4 grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm\">\n                <p><span className=\"font-semibold\">Program:</span> {selectedProgram?.name}</p>\n                <p><span className=\"font-semibold\">Batch:</span> {selectedBatch}</p>\n                <p><span className=\"font-semibold\">Course:</span> {course.code} - {course.name}</p>\n                <p><span className=\"font-semibold\">Scope:</span> {scopeName}</p>\n                <p><span className=\"font-semibold\">Faculty:</span> {currentUser?.name}</p>\n                <p><span className=\"font-semibold\">Employee ID:</span> {currentUser?.employeeId}</p>\n            </div>\n        </div>\n        \n        {/* Overall Attainment by CO */}\n        <section>\n            <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Overall Attainment by Course Outcome</h2>\n            <p className=\"text-xs text-gray-500 mb-2\">Based on {coAttainmentData.studentCount} students in scope.</p>\n            <table className=\"min-w-full border-collapse border border-gray-400\">\n                <thead className=\"bg-gray-200\">\n                    <tr>\n                        <th className=\"p-2 text-left font-medium border border-gray-400\">CO</th>\n                        <th className=\"p-2 text-left font-medium border border-gray-400\">Description</th>\n                        <th className=\"p-2 text-center font-medium border border-gray-400\">% Students Above Target ({course.target}%)</th>\n                        <th className=\"p-2 text-center font-medium border border-gray-400\">Attainment Level</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    {coAttainmentData.results.map(({ co, percentageMeetingTarget, attainmentLevel }) => (\n                        <tr key={co.id}>\n                            <td className=\"p-2 font-medium border border-gray-400\">{co.number}</td>\n                            <td className=\"p-2 border border-gray-400\">{co.description}</td>\n                            <td className=\"p-2 text-center font-semibold border border-gray-400\">{percentageMeetingTarget.toFixed(1)}%</td>\n                            <td className={`p-2 text-center font-bold text-lg border border-gray-400 ${attainmentLevelColors[attainmentLevel].replace('bg-', 'text-').split(' ')[1]}`}>{attainmentLevel}</td>\n                        </tr>\n                    ))}\n                </tbody>\n            </table>\n        </section>\n\n        {/* Student-wise Attainment */}\n        <section>\n            <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Student-wise Attainment Details</h2>\n            <table className=\"min-w-full border-collapse border border-gray-400\">\n                <thead className=\"bg-gray-200\">\n                    <tr>\n                        <th className=\"p-2 text-left font-medium border border-gray-400\">Student ID</th>\n                        <th className=\"p-2 text-left font-medium border border-gray-400\">Student Name</th>\n                        {studentAttainmentData.courseOutcomes.map(co => (\n                            <th key={co.id} className=\"p-2 text-center font-medium border border-gray-400\">{co.number}</th>\n                        ))}\n                    </tr>\n                </thead>\n                <tbody>\n                    {studentAttainmentData.students.map(student => (\n                        <tr key={student.id}>\n                            <td className=\"p-2 font-medium border border-gray-400\">{student.id}</td>\n                            <td className=\"p-2 border border-gray-400\">{student.name}</td>\n                            {studentAttainmentData.courseOutcomes.map(co => {\n                                const attainment = studentAttainmentData.reportData.get(student.id)?.[co.id] ?? 0;\n                                const achievedTarget = attainment >= course.target;\n                                return (\n                                    <td key={co.id} className={`p-2 text-center font-semibold border border-gray-400 ${achievedTarget ? 'text-green-700' : 'text-red-700'}`}>\n                                        {attainment.toFixed(1)}%\n                                    </td>\n                                );\n                            })}\n                        </tr>\n                    ))}\n                </tbody>\n            </table>\n        </section>\n    </div>\n  );\n};\n\nexport default CourseAttainmentSummaryReport;",
  "components/reports/AssessmentComparisonReport.tsx": "/**\n * @file AssessmentComparisonReport.tsx\n * @description\n * This component generates the \"Assessment Comparison Report\", which is designed to be\n * displayed inside the `PrintableReport` previewer.\n *\n * It provides a detailed breakdown of each student's performance across all the assessments\n * within a course, allowing for easy comparison of results from different tests or exams.\n *\n * What it does:\n * 1.  **Fetches and Calculates Data**: It finds all students and all assessments within the given\n *     course and scope (overall or a specific section).\n * 2.  **Calculates Scores**: For each student, it calculates their final percentage score on each\n *     individual assessment.\n * 3.  **Renders Header**: Displays a professional header with the university logo and all\n *     relevant report details.\n * 4.  **Renders Comparison Table**: Displays a table with students as rows and assessments as\n *     columns, with each cell showing the student's percentage score for that assessment.\n */\n\nimport React, { useMemo } from 'react';\nimport { useAppContext } from '../../hooks/useAppContext';\n\n// Defines the props this component accepts from its parent (`AttainmentReports.tsx`).\ninterface ReportProps {\n  courseId: string;\n  scopeId: string; // 'overall' or a section ID.\n}\n\nconst AssessmentComparisonReport: React.FC<ReportProps> = ({ courseId, scopeId }) => {\n  // Get all data and user info from the \"magic backpack\".\n  const { data, selectedProgram, selectedBatch, currentUser } = useAppContext();\n\n  /**\n   * `useMemo` is a smart calculator that performs all the complex data fetching and\n   * calculations for this specific report. It only recalculates when its inputs change.\n   */\n  const {\n    course,\n    assessments,\n    students,\n    reportData,\n    scopeName\n  } = useMemo(() => {\n    const course = data.courses.find(c => c.id === courseId);\n    if (!course) return { course: null, assessments: [], students: [], reportData: new Map(), scopeName: '' };\n    \n    // --- Step 1: Filter students based on the selected scope. ---\n    let studentsInScope;\n    if (scopeId === 'overall') {\n        const batch = data.batches.find(b => b.programId === course.programId && b.name === selectedBatch);\n        if (!batch) return { course, assessments: [], students: [], reportData: new Map(), scopeName: 'Overall' };\n        \n        const sectionIdsForBatch = new Set(data.sections.filter(s => s.batchId === batch.id).map(s => s.id));\n        const studentIdsInBatch = new Set(data.students.filter(s => s.sectionId && sectionIdsForBatch.has(s.sectionId)).map(s => s.id));\n        studentsInScope = data.students.filter(s => s.status === 'Active' && studentIdsInBatch.has(s.id) && data.enrollments.some(e => e.studentId === s.id && e.courseId === course.id));\n    } else {\n         studentsInScope = data.students.filter(s => s.status === 'Active' && s.sectionId === scopeId && data.enrollments.some(e => e.studentId === s.id && e.courseId === course.id));\n    }\n\n    // --- Step 2: Find all assessments relevant to the scope. ---\n    const relevantSectionIds = scopeId === 'overall'\n        ? new Set(data.enrollments.filter(e => e.courseId === course.id && e.sectionId).map(e => e.sectionId!))\n        : new Set([scopeId]);\n        \n    const assessmentsForScope = data.assessments\n        .filter(a => relevantSectionIds.has(a.sectionId))\n        .sort((a,b) => a.name.localeCompare(b.name));\n\n    // --- Step 3: Calculate each student's percentage on each assessment. ---\n    const reportDataMap = new Map<string, { [assessmentId: string]: number }>();\n    studentsInScope.forEach(student => {\n        const studentScores: { [assessmentId: string]: number } = {};\n        assessmentsForScope.forEach(assessment => {\n            const studentMark = data.marks.find(m => m.studentId === student.id && m.assessmentId === assessment.id);\n            if (studentMark) {\n                const totalObtained = studentMark.scores.reduce((sum, s) => sum + s.marks, 0);\n                const totalMax = assessment.questions.reduce((sum, q) => sum + q.maxMarks, 0);\n                studentScores[assessment.id] = totalMax > 0 ? (totalObtained / totalMax) * 100 : 0;\n            } else {\n                studentScores[assessment.id] = 0; // If no marks entry, score is 0.\n            }\n        });\n        reportDataMap.set(student.id, studentScores);\n    });\n\n    const scopeNameText = scopeId === 'overall' ? 'Overall Course' : `Section ${data.sections.find(s => s.id === scopeId)?.name}`;\n\n    return {\n        course,\n        assessments: assessmentsForScope,\n        students: studentsInScope.sort((a,b) => a.id.localeCompare(b.id)),\n        reportData: reportDataMap,\n        scopeName: scopeNameText\n    };\n  }, [data, courseId, scopeId, selectedBatch]);\n\n  if (!course) return <p className=\"text-red-500\">Course not found.</p>;\n\n  return (\n    <div className=\"space-y-8 text-sm\">\n      {/* Report Header */}\n      <div className=\"mb-8 pb-4 border-b-2 border-gray-800\">\n        <div className=\"flex justify-between items-center\">\n            <div>\n                <h1 className=\"text-2xl font-bold text-gray-800\">Assessment Comparison Report</h1>\n                <p className=\"text-gray-600\">Generated on: {new Date().toLocaleDateString()}</p>\n            </div>\n            <img src=\"https://d1hbpr09pwz0sk.cloudfront.net/logo_url/chitkara-university-4c35e411\" alt=\"Logo\" className=\"h-16\" />\n        </div>\n        <div className=\"mt-4 grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm\">\n            <p><span className=\"font-semibold\">Program:</span> {selectedProgram?.name}</p>\n            <p><span className=\"font-semibold\">Batch:</span> {selectedBatch}</p>\n            <p><span className=\"font-semibold\">Course:</span> {course.code} - {course.name}</p>\n            <p><span className=\"font-semibold\">Scope:</span> {scopeName}</p>\n            <p><span className=\"font-semibold\">Faculty:</span> {currentUser?.name}</p>\n            <p><span className=\"font-semibold\">Employee ID:</span> {currentUser?.employeeId}</p>\n        </div>\n      </div>\n      \n      {/* Main Report Table */}\n      <section>\n        <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Student Performance Across Assessments</h2>\n        <table className=\"min-w-full border-collapse border border-gray-400\">\n            <thead className=\"bg-gray-200\">\n                <tr>\n                    <th className=\"p-2 text-left font-medium border border-gray-400\">Student ID</th>\n                    <th className=\"p-2 text-left font-medium border border-gray-400\">Student Name</th>\n                    {assessments.map(assessment => (\n                        <th key={assessment.id} className=\"p-2 text-center font-medium border border-gray-400\">{assessment.name}</th>\n                    ))}\n                </tr>\n            </thead>\n            <tbody>\n                {students.map(student => (\n                    <tr key={student.id}>\n                        <td className=\"p-2 font-medium border border-gray-400\">{student.id}</td>\n                        <td className=\"p-2 border border-gray-400\">{student.name}</td>\n                        {assessments.map(assessment => {\n                            const percentage = reportData.get(student.id)?.[assessment.id] ?? 0;\n                            return (\n                                <td key={assessment.id} className={`p-2 text-center font-semibold border border-gray-400`}>\n                                    {percentage.toFixed(1)}%\n                                </td>\n                            );\n                        })}\n                    </tr>\n                ))}\n                {students.length === 0 && (\n                    <tr>\n                        <td colSpan={assessments.length + 2} className=\"text-center p-4 border border-gray-400\">No student data found for this scope.</td>\n                    </tr>\n                )}\n            </tbody>\n        </table>\n      </section>\n    </div>\n  );\n};\n\nexport default AssessmentComparisonReport;"
}